# GitHub Copilot Instructions

Este documento fornece instru√ß√µes espec√≠ficas para o GitHub Copilot ao trabalhar no projeto **Bot Sinais - Sistema de Trading**.

## üéØ Sobre o Projeto

Este √© um sistema de sinais de trading baseado em **Domain-Driven Design (DDD)** com arquitetura orientada a eventos usando **MassTransit** e **RabbitMQ**. O sistema utiliza **.NET Aspire** para orquestra√ß√£o da infraestrutura e √© dividido em tr√™s contextos delimitados principais.

## üèóÔ∏è Arquitetura do Sistema

### Contextos Delimitados

1. **üìä DataManagement** - Gerenciamento de dados de mercado
2. **üìà Signals** - Gera√ß√£o e execu√ß√£o de sinais de trading  
3. **üîß Strategies** - Cria√ß√£o e execu√ß√£o de estrat√©gias (C#, Python, Julia)

### Tecnologias Principais
- **.NET 9.0** (C#)
- **.NET Aspire** (orquestra√ß√£o e observabilidade)
- **MassTransit 8.2.0** com RabbitMQ
- **Entity Framework Core** (para persist√™ncia)
- **ASP.NET Core** (APIs e Web)
- **Keycloak** (autentica√ß√£o e autoriza√ß√£o)
- **PostgreSQL** (banco de dados)
- **Python/Julia** (engines de estrat√©gias)

### Arquitetura de Projetos
- **BotSinais.AppHost** - .NET Aspire orchestrator (infraestrutura)
- **BotSinais.ApiService** - API endpoints (m√≠nima configura√ß√£o)
- **BotSinais.Web** - Interface web (Blazor)
- **BotSinais.Infrastructure** - **TODAS as configura√ß√µes e inje√ß√µes de depend√™ncia**
- **BotSinais.Domain** - Dom√≠nio puro (sem depend√™ncias)
- **BotSinais.ServiceDefaults** - Configura√ß√µes padr√£o Aspire

## üìù Conven√ß√µes de C√≥digo

### Namespaces
```csharp
// DOMAIN - Sem depend√™ncias externas
BotSinais.Domain.Shared                         // Classes base e tipos compartilhados
BotSinais.Domain.Shared.Events                  // Eventos de dom√≠nio e interfaces
BotSinais.Domain.Shared.ValueObjects            // Value Objects (Price, Volume, Symbol)
BotSinais.Domain.Shared.Enums                   // Enumera√ß√µes (InstrumentType, TimeFrame, etc.)
BotSinais.Domain.Modules.DataManagement.Entities    // Entidades de dados
BotSinais.Domain.Modules.DataManagement.Interfaces  // Interfaces de dados
BotSinais.Domain.Modules.Signals.Entities           // Entidades de sinais
BotSinais.Domain.Modules.Signals.Interfaces         // Interfaces de sinais
BotSinais.Domain.Modules.Strategies.Entities        // Entidades de estrat√©gias
BotSinais.Domain.Modules.Strategies.Interfaces      // Interfaces de estrat√©gias

// INFRASTRUCTURE - Implementa√ß√µes organizadas por m√≥dulos
BotSinais.Infrastructure.Modules.Auth                   // Autentica√ß√£o Keycloak, middlewares, controllers
BotSinais.Infrastructure.Modules.Signals                // Controllers de sinais, handlers MassTransit
BotSinais.Infrastructure.Modules.DataManagement         // Entity Framework, reposit√≥rios, controllers de dados
BotSinais.Infrastructure.Modules.Strategies             // Engines C#/Python/Julia, controllers de estrat√©gias
BotSinais.Infrastructure.Shared                         // Configura√ß√µes unificadas de todos os m√≥dulos
```

### Padr√µes de Nomenclatura

#### Entidades
- Use PascalCase
- Nomes descritivos: `TradingSignal`, `MarketData`, `StrategyExecution`
- Herdem de `BaseEntity` quando apropriado

#### Value Objects
- Use `record` quando poss√≠vel
- Exemplos: `Price`, `Volume`, `Symbol`
- Inclua valida√ß√£o no construtor

#### Eventos
- Sufixo `Event`: `SignalGeneratedEvent`, `MarketDataReceivedEvent`
- Herdem de `DomainEvent`
- Use `record` para imutabilidade

#### Interfaces
- Prefixo `I`: `IStrategyRepository`, `ISignalExecutionService`
- Reposit√≥rios: `I{Entity}Repository`
- Servi√ßos: `I{Domain}Service`

### Estrutura de Entidades

```csharp
public class ExampleEntity : BaseEntity, IVersionedEntity
{
    [Required]
    [MaxLength(100)]
    public string Name { get; set; } = null!;
    
    public int Version { get; set; } = 1;
    
    // Relacionamentos
    public virtual ICollection<RelatedEntity> Items { get; set; } = new List<RelatedEntity>();
}
```

## üîÑ Padr√µes de Eventos

### Publica√ß√£o de Eventos
```csharp
// Sempre use IDomainEventPublisher
await _eventPublisher.PublishAsync(new SignalGeneratedEvent
{
    SignalId = signal.Id,
    InstrumentId = signal.InstrumentId,
    // ... outras propriedades
}, cancellationToken);
```

### Consumo de Eventos
```csharp
public class SignalEventHandler : DomainEventHandler<SignalGeneratedEvent>
{
    public SignalEventHandler(ILogger<SignalEventHandler> logger) : base(logger) { }
    
    protected override async Task HandleAsync(SignalGeneratedEvent @event, CancellationToken cancellationToken)
    {
        // Implementa√ß√£o do handler
    }
}
```

## üõ†Ô∏è Padr√µes de Implementa√ß√£o

### Configura√ß√£o de Infraestrutura (.NET Aspire)
```csharp
// AppHost.cs - Orquestra√ß√£o da infraestrutura
var builder = DistributedApplication.CreateBuilder(args);

// Recursos de infraestrutura
var postgres = builder.AddPostgres("postgres");
var rabbitmq = builder.AddRabbitMQ("messaging");
var keycloak = builder.AddKeycloak("keycloak", 8080);

// Projetos da aplica√ß√£o
var apiService = builder.AddProject<Projects.BotSinais_ApiService>("apiservice")
    .WithReference(postgres)
    .WithReference(rabbitmq)
    .WithReference(keycloak);
```

### Configura√ß√£o Centralizada em Infrastructure (Modular)
**IMPORTANTE**: Todas as configura√ß√µes de DI, controllers, minimal APIs e middlewares devem ser organizadas por **m√≥dulos** no projeto **BotSinais.Infrastructure**, seguindo os contextos delimitados do DDD.

#### Estrutura Modular
```
BotSinais.Infrastructure/
‚îú‚îÄ‚îÄ Modules/
‚îÇ   ‚îú‚îÄ‚îÄ Auth/                    # Autentica√ß√£o e autoriza√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ Signals/                 # Sinais de trading  
‚îÇ   ‚îú‚îÄ‚îÄ DataManagement/          # Dados de mercado
‚îÇ   ‚îî‚îÄ‚îÄ Strategies/              # Estrat√©gias de trading
‚îî‚îÄ‚îÄ Shared/                      # Configura√ß√µes unificadas
```

#### Configura√ß√£o por M√≥dulo
```csharp
// BotSinais.Infrastructure/Modules/Auth/ServiceCollectionExtensions.cs
public static class ServiceCollectionExtensions
{
    public static IServiceCollection AddAuthModule(this IServiceCollection services, IConfiguration configuration)
    {
        services.AddAuthKeycloak(configuration);
        // Configura√ß√µes espec√≠ficas do m√≥dulo Auth
        return services;
    }
}

// BotSinais.Infrastructure/Modules/Auth/WebApplicationExtensions.cs
public static class WebApplicationExtensions
{
    public static WebApplication UseAuthModule(this WebApplication app)
    {
        app.UseAuthentication();
        app.UseAuthorization();
        return app;
    }
}
```

#### Configura√ß√£o Unificada (Shared)
```csharp
// BotSinais.Infrastructure/Shared/ServiceCollectionExtensions.cs
public static IServiceCollection AddBotSinaisInfrastructure(this IServiceCollection services, IConfiguration configuration)
{
    services.AddControllers();
    
    // Todos os m√≥dulos
    services.AddAuthModule(configuration);
    services.AddSignalsModule(configuration);
    services.AddDataManagementModule(configuration);
    services.AddStrategiesModule(configuration);
    
    return services;
}
```

### Projeto ApiService M√≠nimo
O projeto **BotSinais.ApiService** deve ter configura√ß√£o m√≠nima usando o m√≥dulo **Shared**:

```csharp
// Program.cs - ApiService (M√çNIMO)
using BotSinais.Infrastructure.Shared;

var builder = WebApplication.CreateBuilder(args);
builder.AddServiceDefaults();

// Configura√ß√£o centralizada unificada (todos os m√≥dulos)
builder.Services.AddBotSinaisInfrastructure(builder.Configuration);

var app = builder.Build();

// Pipeline centralizado unificado (todos os m√≥dulos)
app.ConfigureBotSinaisPipeline();
app.MapDefaultEndpoints();
app.Run();
```

### Reposit√≥rios
```csharp
public interface IExampleRepository
{
    Task<Example?> GetByIdAsync(Guid id, CancellationToken cancellationToken = default);
    Task<IEnumerable<Example>> GetActiveAsync(CancellationToken cancellationToken = default);
    Task<Example> CreateAsync(Example entity, CancellationToken cancellationToken = default);
    Task<Example> UpdateAsync(Example entity, CancellationToken cancellationToken = default);
    Task DeleteAsync(Guid id, CancellationToken cancellationToken = default);
}
```

### Servi√ßos de Dom√≠nio
```csharp
public interface IExampleService
{
    Task<Result> ProcessAsync(Guid id, Dictionary<string, object> parameters, CancellationToken cancellationToken = default);
    Task<bool> ValidateAsync(Example entity, CancellationToken cancellationToken = default);
}
```

## üí∞ Contexto Financeiro

### Tipos de Instrumentos
- **Stock** - A√ß√µes
- **Forex** - C√¢mbio
- **Crypto** - Criptomoedas
- **Commodity** - Commodities
- **Index** - √çndices
- **Future** - Futuros
- **Option** - Op√ß√µes

### Timeframes Suportados
- **M1, M5, M15, M30** - Minutos
- **H1, H4** - Horas  
- **D1** - Di√°rio
- **W1** - Semanal
- **MN1** - Mensal

### Dire√ß√µes de Trading
- **Buy** - Compra
- **Sell** - Venda
- **Hold** - Manter posi√ß√£o

## üîß Execu√ß√£o Multi-Linguagem

### Linguagens Suportadas
```csharp
public enum ExecutionLanguage
{
    CSharp,  // Estrat√©gias em C#
    Python,  // Estrat√©gias em Python
    Julia    // Estrat√©gias em Julia
}
```

### Estrutura de Estrat√©gias
- C√≥digo fonte armazenado como string
- Par√¢metros configur√°veis via Dictionary
- Templates reutiliz√°veis dispon√≠veis
- Isolamento por ExecutionEngine

## üìä M√©tricas e Performance

### M√©tricas de Backtest
- **TotalReturn** - Retorno total
- **SharpeRatio** - √çndice Sharpe
- **MaxDrawdown** - Maior perda
- **WinRate** - Taxa de acerto
- **ProfitFactor** - Fator de lucro

### Gest√£o de Risco
- **MaxRiskPerTrade** - Risco m√°ximo por opera√ß√£o (padr√£o: 2%)
- **MaxPortfolioRisk** - Risco m√°ximo do portfolio (padr√£o: 20%)

## üö® Tratamento de Erros

### Eventos de Erro
```csharp
await _eventPublisher.PublishAsync(new SystemErrorEvent
{
    Component = "ComponentName",
    ErrorType = "ErrorType",
    Message = ex.Message,
    StackTrace = ex.StackTrace,
    Context = new Dictionary<string, object> { /* contexto */ }
}, cancellationToken);
```

### Valida√ß√µes
- Sempre validar entradas
- Usar Data Annotations onde apropriado
- Implementar valida√ß√µes de neg√≥cio nos servi√ßos

## üß™ Testes

### Conven√ß√µes de Teste
- Use AAA pattern (Arrange, Act, Assert)
- Nomes descritivos: `Should_CreateSignal_When_ValidParametersProvided`
- Mock depend√™ncias externas
- Teste cen√°rios de erro

### Exemplo de Teste
```csharp
[Fact]
public async Task Should_GenerateSignal_When_MarketDataReceived()
{
    // Arrange
    var marketData = new MarketDataReceivedEvent { /* dados */ };
    
    // Act
    var result = await _service.ProcessAsync(marketData);
    
    // Assert
    result.Should().NotBeNull();
    result.Direction.Should().Be(TradeDirection.Buy);
}
```

## üìÅ Estrutura de Arquivos

```
src-cs/
‚îú‚îÄ‚îÄ BotSinais.Domain/                       # ‚ö° Domain puro - sem depend√™ncias externas
‚îÇ   ‚îú‚îÄ‚îÄ Shared/                             # Arquivos compartilhados entre contextos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Entities/                       # Entidades base (BaseEntity, etc.)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Interfaces/                     # Interfaces base (ICommand, IQuery, IRepositoryBase)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ValueObjects/                   # Value Objects - um arquivo por tipo
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Price.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Volume.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Symbol.cs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Enums/                          # Enumera√ß√µes - um arquivo por enum
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ InstrumentType.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TimeFrame.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TradeDirection.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SignalStatus.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ StrategyType.cs
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ExecutionLanguage.cs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Events/                         # Eventos de dom√≠nio (abstra√ß√µes puras)
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ DomainEvents.cs             # Defini√ß√µes dos eventos
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ IDomainEventPublisher.cs    # Interface para publica√ß√£o
‚îÇ   ‚îî‚îÄ‚îÄ Modules/                            # Contextos delimitados (Bounded Contexts)
‚îÇ       ‚îú‚îÄ‚îÄ DataManagement/                 # Contexto de dados
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ Entities/                   # Uma entidade por arquivo
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Instrument.cs
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MarketData.cs
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ Interfaces/                 # Uma interface por arquivo
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ IInstrumentRepository.cs
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ IMarketDataRepository.cs
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îÇ       ‚îú‚îÄ‚îÄ Signals/                        # Contexto de sinais
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ Entities/                   # Uma entidade por arquivo
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TradingSignal.cs
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Portfolio.cs
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ Interfaces/                 # Uma interface por arquivo
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ ITradingSignalRepository.cs
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ IPortfolioRepository.cs
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îÇ       ‚îî‚îÄ‚îÄ Strategies/                     # Contexto de estrat√©gias
‚îÇ           ‚îú‚îÄ‚îÄ Entities/                   # Uma entidade por arquivo
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ Strategy.cs
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ StrategyExecution.cs
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ           ‚îî‚îÄ‚îÄ Interfaces/                 # Uma interface por arquivo
‚îÇ               ‚îú‚îÄ‚îÄ IStrategyRepository.cs
‚îÇ               ‚îú‚îÄ‚îÄ IStrategyExecutionService.cs
‚îÇ               ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ BotSinais.Infrastructure/               # üîå Implementa√ß√µes e depend√™ncias externas
‚îÇ   ‚îú‚îÄ‚îÄ Modules/                            # M√≥dulos organizados por contexto delimitado
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Auth/                           # M√≥dulo de autentica√ß√£o
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Controllers/                # Controllers e testes HTTP
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ AuthController.cs      # Controller de autentica√ß√£o
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ AuthController.http    # ‚≠ê Testes HTTP do controller
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Signals/                        # M√≥dulo de sinais
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Controllers/                # Controllers e testes HTTP
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ TradingSignalsController.cs
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ TradingSignals.http    # ‚≠ê Testes HTTP do controller
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [outros m√≥dulos...]
‚îÇ   ‚îî‚îÄ‚îÄ Events/                             # Infraestrutura de eventos
‚îÇ       ‚îú‚îÄ‚îÄ EventInfrastructure.cs         # Implementa√ß√£o MassTransit
‚îÇ       ‚îî‚îÄ‚îÄ EventHandlerExamples.cs        # Exemplos de handlers
‚îú‚îÄ‚îÄ BotSinais.Application/                  # Casos de uso e handlers
‚îú‚îÄ‚îÄ BotSinais.ApiService/                   # API REST
‚îú‚îÄ‚îÄ BotSinais.Web/                         # Interface web
‚îî‚îÄ‚îÄ BotSinais.Tests/                       # Testes unit√°rios
```

## üîí Seguran√ßa

### Configura√ß√µes Sens√≠veis
- Use `IConfiguration` para configura√ß√µes
- Nunca hardcode connection strings
- Use User Secrets em desenvolvimento
- Variables de ambiente em produ√ß√£o

### Valida√ß√£o de Entrada
```csharp
public async Task<Result> ProcessAsync(ProcessRequest request)
{
    if (request == null)
        throw new ArgumentNullException(nameof(request));
    
    var validationResult = await ValidateAsync(request);
    if (!validationResult.IsValid)
        return Result.Failure(validationResult.Errors);
    
    // Processamento...
}
```

## üìà Performance

### Async/Await
- Sempre use async/await para opera√ß√µes I/O
- Passe CancellationToken em m√©todos async
- Use ConfigureAwait(false) em bibliotecas

### Caching
- Cache dados que mudam pouco (instrumentos, configura√ß√µes)
- Use IMemoryCache para cache local
- Redis para cache distribu√≠do quando necess√°rio

## üé® Copilot - Diretrizes Espec√≠ficas

### Ao Sugerir C√≥digo:
1. **Sempre** considere o contexto de DDD e os bounded contexts
2. **Use** .NET Aspire para orquestra√ß√£o de infraestrutura
3. **Organize** por m√≥dulos seguindo contextos delimitados (Auth, Signals, DataManagement, Strategies)
4. **Centralize** configura√ß√µes no m√≥dulo **Shared** para unificar tudo
5. **Use** os padr√µes estabelecidos (Repository, Domain Events)
6. **Inclua** logging e tratamento de erro apropriados
7. **Considere** performance e async patterns
8. **Valide** entrada de dados
9. **Use** os tipos espec√≠ficos do dom√≠nio (Price, Volume, Symbol)
10. **Publique** eventos de dom√≠nio quando apropriado
11. **Mantenha** separa√ß√£o entre contextos/m√≥dulos
12. **Use** dependency injection modular no Infrastructure
13. **Inclua** documenta√ß√£o XML para APIs p√∫blicas
14. **Configure** pipelines e middlewares por m√≥dulo
15. **Mantenha** projetos de API/Web m√≠nimos, delegando para Infrastructure.Shared

### Ao Gerar Testes:
1. **Teste** cen√°rios positivos e negativos
2. **Mock** depend√™ncias externas
3. **Use** dados realistas para trading
4. **Teste** valida√ß√µes de neg√≥cio
5. **Verifique** eventos publicados

### Arquivos de Teste HTTP:
1. **Localiza√ß√£o**: Arquivos `.http` devem ficar no mesmo diret√≥rio do controller que testam
2. **Nomenclatura**: Use o mesmo nome do controller (ex: `AuthController.http` para `AuthController.cs`)
3. **Organiza√ß√£o**: Agrupe testes por funcionalidade com coment√°rios descritivos
4. **Vari√°veis**: Use vari√°veis para URLs base e tokens para facilitar testes
5. **Exemplo**: `BotSinais.Infrastructure/Modules/Auth/Controllers/AuthController.http`

### Linguagem:
- **Coment√°rios** em portugu√™s brasileiro
- **Nomes** de classes/m√©todos em ingl√™s
- **Documenta√ß√£o** em portugu√™s
- **Logs** em portugu√™s